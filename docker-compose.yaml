services:
  base: &base
    image: chatwoot/chatwoot:latest
    volumes:
      - chatwoot_storage:/app/storage

  # ðŸ”§ Init Container - ADICIONADO para setup automÃ¡tico
  chatwoot-init:
    <<: *base
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - RAILS_ENV=production
      - SECRET_KEY_BASE=17b5a9415c4337cd47e3bb9bb38dfc1126681a031d92413e1548e471ebb79e9f5ecdf5cd21aacb2dcd6015f359f1107a9ed876d322f19cdf719954794d2b55ed
      - DATABASE_URL=postgresql://postgres:postgres_teste_123@postgres:5432/chatwoot
      - REDIS_URL=redis://:redis_teste_123@redis:6379
    command: >
      sh -c "
      echo 'ðŸ”§ Iniciando setup do Chatwoot...' &&
      bundle exec rails db:prepare &&
      echo 'ðŸ‘¤ Criando usuÃ¡rio admin...' &&
      bundle exec rails runner \"
      begin
        if User.where(email: 'admin@localhost.com').exists?
          puts 'âœ… UsuÃ¡rio admin jÃ¡ existe'
        else
          user = User.create!(
            name: 'Administrador',
            email: 'admin@localhost.com',
            password: '#Cabemce2025#',
            password_confirmation: '#Cabemce2025#',
            confirmed_at: Time.current
          )
          account = Account.create!(name: 'Minha Empresa')
          AccountUser.create!(account: account, user: user, role: 'administrator')
          puts 'âœ… UsuÃ¡rio admin criado: admin@localhost.com / '#Cabemce2025#
        end
      rescue => e
        puts 'Erro: ' + e.message
      end
      \" &&
      echo 'âœ… Setup concluÃ­do!'
      "
    restart: "no"

  rails:
    <<: *base
    depends_on:
      chatwoot-init:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - '127.0.0.1:3000:3000'
    environment:
      - NODE_ENV=production
      - RAILS_ENV=production
      - INSTALLATION_ENV=docker
      # ConfiguraÃ§Ãµes de teste do Chatwoot
      - SECRET_KEY_BASE=17b5a9415c4337cd47e3bb9bb38dfc1126681a031d92413e1548e471ebb79e9f5ecdf5cd21aacb2dcd6015f359f1107a9ed876d322f19cdf719954794d2b55ed
      - FRONTEND_URL=http://localhost:3000
      - REQUIRE_EMAIL_CONFIRMATION=false
      - ENABLE_ACCOUNT_SIGNUP=true
      - DATABASE_URL=postgresql://postgres:postgres_teste_123@postgres:5432/chatwoot
      - REDIS_URL=redis://:redis_teste_123@redis:6379
    entrypoint: docker/entrypoints/rails.sh
    command: ['bundle', 'exec', 'rails', 's', '-p', '3000', '-b', '0.0.0.0']
    restart: always
    networks:
      - default

  sidekiq:
    <<: *base
    depends_on:
      chatwoot-init:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - NODE_ENV=production
      - RAILS_ENV=production
      - INSTALLATION_ENV=docker
      # ConfiguraÃ§Ãµes de teste do Chatwoot - CORRIGIDO: mesma SECRET_KEY_BASE
      - SECRET_KEY_BASE=17b5a9415c4337cd47e3bb9bb38dfc1126681a031d92413e1548e471ebb79e9f5ecdf5cd21aacb2dcd6015f359f1107a9ed876d322f19cdf719954794d2b55ed
      - DATABASE_URL=postgresql://postgres:postgres_teste_123@postgres:5432/chatwoot
      - REDIS_URL=redis://:redis_teste_123@redis:6379
    command: ['bundle', 'exec', 'sidekiq', '-C', 'config/sidekiq.yml']
    restart: always
    networks:
      - default

  postgres:
    image: pgvector/pgvector:pg16
    restart: always
    ports:
      - '127.0.0.1:5433:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=chatwoot
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres_teste_123
    # ADICIONADO: Health check para aguardar postgres ficar pronto
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d chatwoot"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - default

  redis:
    image: redis:alpine
    restart: always
    command: ["sh", "-c", "redis-server --requirepass \"redis_teste_123\""]
    volumes:
      - redis_data:/data
    ports:
      - '127.0.0.1:6379:6379'
    # ADICIONADO: Health check para aguardar redis ficar pronto
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "redis_teste_123", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - default

  n8n:
    image: docker.n8n.io/n8nio/n8n
    restart: always
    ports:
      - '127.0.0.1:5678:5678'
    volumes:
      - n8n_data:/home/node/.n8n
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=teste_123
      - N8N_SECURE_COOKIE=false
      - TZ=America/Sao_Paulo
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - default

  evolution-api:
    container_name: evolution_api
    image: atendai/evolution-api:latest
    restart: always
    ports:
      - '127.0.0.1:8081:8080'
    environment:
      - SERVER_TYPE=http
      - SERVER_PORT=8080
      - SERVER_URL=http://localhost:8081
      - DATABASE_PROVIDER=postgresql
      - DATABASE_CONNECTION_URI=postgresql://evolution_user:evolution_teste_123@evolution-db:5432/evolution?schema=public
      - CACHE_REDIS_ENABLED=true
      - CACHE_REDIS_URI=redis://evolution-redis:6379/6
      - AUTHENTICATION_API_KEY=429683C4C977415CAAFCCE10F7D57E11
      - LANGUAGE=pt-BR
      - CONFIG_SESSION_PHONE_VERSION=2.3000.1032622985
    volumes:
      - evolution_store:/evolution/store
      - evolution_instances:/evolution/instances
    depends_on:
      evolution-db:
        condition: service_healthy
      evolution-redis:
        condition: service_healthy
    networks:
      - default

  evolution-db:
    container_name: evolution_db
    image: postgres:15
    restart: always
    environment:
      - POSTGRES_USER=evolution_user
      - POSTGRES_PASSWORD=evolution_teste_123
      - POSTGRES_DB=evolution
    volumes:
      - evolution_db_data:/var/lib/postgresql/data
    # ADICIONADO: Health check para aguardar postgres ficar pronto
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U evolution_user -d evolution"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - default

  evolution-redis:
    container_name: evolution_redis
    image: redis:7-alpine
    restart: always
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    volumes:
      - evolution_redis_data:/data
    # ADICIONADO: Health check para aguardar redis ficar pronto
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - default

  # Workspace Laravel para FAQ System
  faq-workspace:
    container_name: faq_workspace
    image: laravelsail/php83-composer:latest
    restart: unless-stopped
    working_dir: /var/www/faq-cabemce
    ports:
      - '127.0.0.1:8080:8000'
    volumes:
      - ./faq-cabemce:/var/www/faq-cabemce
    environment:
      - APP_ENV=local
      - APP_DEBUG=true
      - DB_CONNECTION=pgsql
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_DATABASE=faq_system
      - DB_USERNAME=postgres
      - DB_PASSWORD=postgres_teste_123
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - default
    command: bash -c "apt-get update && apt-get install -y postgresql-client libpq-dev libicu-dev && docker-php-ext-install pdo_pgsql pgsql intl && cd /var/www/faq-cabemce && php artisan serve --host=0.0.0.0 --port=8000"

  # ðŸŒ Ngrok - TÃºnel para expor serviÃ§os localmente
  ngrok:
    container_name: ngrok_tunnel
    image: ngrok/ngrok:latest
    restart: unless-stopped
    ports:
      - '4040:4040'  # Interface web do ngrok
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN:-}  # Token do ngrok (obrigatÃ³rio)
    command:
      - "start"
      - "--authtoken"
      - "${NGROK_AUTHTOKEN}"
      - "--config"
      - "/etc/ngrok.yml"
      - "--all"
    volumes:
      - ./ngrok.yml:/etc/ngrok.yml:ro
    depends_on:
      - faq-workspace
    networks:
      - default

volumes:
  chatwoot_storage:
  postgres_data:
  redis_data:
  n8n_data:
  evolution_store:
  evolution_instances:
  evolution_db_data:
  evolution_redis_data:

networks:
  default:
    name: auto-zap-network
    driver: bridge